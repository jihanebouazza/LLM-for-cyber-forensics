from ..models import MalwareCluster, MalwareClusterMember
from sqlalchemy.orm import Session
from uuid import uuid4

def get_cluster_by_name(db: Session, name: str):
    return db.query(MalwareCluster).filter(MalwareCluster.cluster_name == name).first()


def create_cluster(db: Session, cluster_name: str, description: str | None = None) -> MalwareCluster:
    obj = MalwareCluster(
        id=uuid4(),
        cluster_name=cluster_name,
        description=description,
    )
    db.add(obj)
    return obj


def add_sample_to_cluster(db: Session, cluster_id, sample_id) -> MalwareClusterMember:
    # avoid duplicates
    existing = (
        db.query(MalwareClusterMember)
        .filter(
            MalwareClusterMember.cluster_id == cluster_id,
            MalwareClusterMember.sample_id == sample_id
        )
        .first()
    )
    if existing:
        return existing

    obj = MalwareClusterMember(
        cluster_id=cluster_id,
        sample_id=sample_id,
    )
    db.add(obj)
    return obj


def get_clusters_for_sample(db: Session, sample_id):
    return (
        db.query(MalwareCluster)
        .join(MalwareClusterMember, MalwareClusterMember.cluster_id == MalwareCluster.id)
        .filter(MalwareClusterMember.sample_id == sample_id)
        .all()
    )


def get_cluster_members(db: Session, cluster_id):
    rows = (
        db.query(MalwareClusterMember)
        .filter(MalwareClusterMember.cluster_id == cluster_id)
        .all()
    )
    return [r.sample_id for r in rows]


def list_clusters(db: Session):
    return db.query(MalwareCluster).all()
