import uuid
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy import Column, ForeignKey,   String, DateTime
from datetime import datetime, timezone
from ..database import Base
from sqlalchemy.orm import relationship


class MalwareSample(Base):
    __tablename__ = "malware_samples"

    id = Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
        unique=True,
        nullable=False,
    )
    filename = Column(String, nullable=False)
    hash = Column(String, unique=True, index=True, nullable=True)
    file_type = Column(String, nullable=True)
    role_in_attack = Column(String, nullable=True)
    category = Column(String, nullable=True)

    malware_family = Column(String, nullable=True)
    variant_label = Column(String, nullable=True)

    campaign_id = Column(UUID(as_uuid=True),
                         ForeignKey("campaigns.id"), index=True,  nullable=True)

    created_at = Column(DateTime, default=lambda: datetime.now(timezone.utc))

    campaign = relationship("Campaign", back_populates="samples")
    analyses = relationship(
        "MalwareAnalysis", back_populates="sample", cascade="all, delete-orphan")
    capabilities = relationship(
        "MalwareCapability", back_populates="sample", cascade="all, delete-orphan")
    recommend_actions = relationship(
        "MalwareRecommendAction", back_populates="sample", cascade="all, delete-orphan")
    iocs = relationship("MalwareIOC", back_populates="sample",
                        cascade="all, delete-orphan")
    config = relationship(
        "MalwareConfig",
        back_populates="sample",
        uselist=False,
        cascade="all, delete-orphan",
    )
    detection_hints = relationship(
        "MalwareDetectionHint", back_populates="sample", cascade="all, delete-orphan")
    cluster_memberships = relationship(
        "MalwareClusterMember", back_populates="sample", cascade="all, delete-orphan")
