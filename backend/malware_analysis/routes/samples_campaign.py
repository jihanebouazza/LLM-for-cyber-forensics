from uuid import UUID
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from ..database import get_db
from ..schemas.sample_update import MalwareSampleUpdateCampaign
from ..schemas.malware_samples import MalwareSampleOut
from ..services.campaigns import set_sample_campaign, get_campaign

router = APIRouter()


@router.patch("/{sample_id}/campaign", response_model=MalwareSampleOut)
def set_campaign(sample_id: UUID, payload: MalwareSampleUpdateCampaign, db: Session = Depends(get_db)):
    # validate campaign exists 
    if payload.campaign_id is not None:
        camp = get_campaign(db, payload.campaign_id)
        if not camp:
            raise HTTPException(status_code=404, detail="Campaign not found")

    sample = set_sample_campaign(db, sample_id, payload.campaign_id)
    if not sample:
        raise HTTPException(status_code=404, detail="Sample not found")

    db.commit()
    db.refresh(sample)
    return sample
