from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from ..schemas.responses import MalwareAnalyzeResponse

from ..database import get_db
from ..schemas.requests import MalwareAnalyzeRequest
from ..services.analysis import analyze_sample

router = APIRouter()


@router.post("/analyze", response_model=MalwareAnalyzeResponse)
def analyze(payload: MalwareAnalyzeRequest, db: Session = Depends(get_db)):
    sample, analyses, iocs, capabilities, config, recommendations, detection_hints = analyze_sample(
        db, payload)
    return {
        "sample": sample,
        "analyses": analyses,
        "iocs": iocs,
        "capabilities": capabilities,
        "config": config,
        "recommendations": recommendations,
        "detection_hints": detection_hints,
    }
