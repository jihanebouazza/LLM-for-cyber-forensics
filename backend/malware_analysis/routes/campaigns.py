from uuid import UUID
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from ..database import get_db
from ..schemas.campaigns import CampaignCreate, CampaignOut
from ..schemas.malware_samples import MalwareSampleOut
from ..crud.malware import (
    create_campaign, list_campaigns, get_campaign, get_campaign_by_name, list_samples_by_campaign
)

router = APIRouter()


@router.post("/campaigns", response_model=CampaignOut)
def create_campaign_route(payload: CampaignCreate, db: Session = Depends(get_db)):
    existing = get_campaign_by_name(db, payload.name)
    if existing:
        return existing
    camp = create_campaign(db, payload.name, payload.description)
    db.commit()
    db.refresh(camp)
    return camp


@router.get("/campaigns", response_model=list[CampaignOut])
def list_campaigns_route(db: Session = Depends(get_db)):
    return list_campaigns(db)


@router.get("/campaigns/{campaign_id}", response_model=CampaignOut)
def get_campaign_route(campaign_id: UUID, db: Session = Depends(get_db)):
    camp = get_campaign(db, campaign_id)
    if not camp:
        raise HTTPException(status_code=404, detail="Campaign not found")
    return camp


@router.get("/campaigns/{campaign_id}/samples", response_model=list[MalwareSampleOut])
def list_campaign_samples_route(campaign_id: UUID, db: Session = Depends(get_db)):
    return list_samples_by_campaign(db, campaign_id)
