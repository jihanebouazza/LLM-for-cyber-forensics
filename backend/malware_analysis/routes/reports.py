from fastapi import APIRouter, UploadFile, File, Form, Depends, HTTPException
from sqlalchemy.orm import Session

from ..database import get_db
from ..services.report_service import analyze_from_pdf_report
from ..schemas.report_responses import AnalyzeFromReportResponse

router = APIRouter()


@router.post("/reports/analyze-pdf", response_model=AnalyzeFromReportResponse)
async def analyze_pdf_report(
    report_pdf: UploadFile = File(...),
    filename: str | None = Form(default=None),
    sample_hash: str | None = Form(default=None),
    db: Session = Depends(get_db),
):
    # PDF only
    if (report_pdf.content_type or "").lower() != "application/pdf" and not (
        report_pdf.filename or ""
    ).lower().endswith(".pdf"):
        raise HTTPException(
            status_code=400, detail="Only PDF reports are supported.")

    return await analyze_from_pdf_report(
        db=db,
        upload=report_pdf,
        filename_override=filename,
        sample_hash=sample_hash,
    )
