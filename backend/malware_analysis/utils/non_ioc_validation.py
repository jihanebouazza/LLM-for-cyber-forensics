import re

NONIOC_KEYWORDS = [
    "verdict", "malicious", "threat", "family", "ransom", "dropped", "created",
    "registry", "scheduled task", "powershell", "cmd.exe", "mutex", "encrypt",
    "persistence", "mitre", "tactic", "technique", "c2", "connect", "http",
    "dns", "url", "domain", "ip", "file", "process", "service"
]


def trim_for_non_iocs(text: str, max_chars: int = 5500) -> str:
    lines = [ln.strip() for ln in (text or "").splitlines() if ln.strip()]
    # Keep: first page-ish + last page-ish
    head = "\n".join(lines[:200])
    tail = "\n".join(lines[-200:])

    # Keep keyword-matching lines
    kw_re = re.compile("|".join(re.escape(k) for k in NONIOC_KEYWORDS), re.I)
    hits = [ln for ln in lines if kw_re.search(ln)]

    # Deduplicate while preserving order
    seen = set()
    hits2 = []
    for ln in hits:
        if ln not in seen:
            seen.add(ln)
            hits2.append(ln)

    excerpt = "\n".join([head, "\n".join(hits2[:250]), tail])
    excerpt = excerpt[:max_chars]
    return excerpt


def _find_line_value(text: str, label: str) -> str | None:
    m = re.search(rf"(?im)^\s*{re.escape(label)}\s*:\s*(.+?)\s*$", text)
    return m.group(1).strip() if m else None


def parse_top_report_fields(report_text: str) -> dict:
    head = (report_text or "")[:12000]

    # These map directly to your sample fields
    file_name = _find_line_value(head, "File name")  # example: QBFRMDZ.exe
    # example: application/vnd.microsoft.portable-executable
    mime = _find_line_value(head, "MIME")
    # example: PE32 executable ...
    file_info = _find_line_value(head, "File info")
    sha256 = _find_line_value(head, "SHA256")        # example: EEDA...

    # "Malicious activity" etc.
    verdict = _find_line_value(head, "Verdict")
    tags_line = _find_line_value(head, "Tags")       # "upx crypto-regex"
    threats_block = None

    # Threats block (often multiline after "Threats:")
    m = re.search(
        r"(?is)^\s*Threats\s*:\s*(.*?)^\s*(Analysis date|OS|Tags|Indicators|MIME|File info|MD5|SHA1|SHA256|SSDEEP)\s*:",
        head,
    )
    if m:
        blob = m.group(1)
        lines = [ln.strip(" \t\r\n-â€¢")
                 for ln in blob.splitlines() if ln.strip()]
        # keep short lines only (avoid long explanation paragraph)
        out = []
        seen = set()
        for ln in lines:
            if len(ln) > 80:
                continue
            k = ln.lower()
            if k not in seen:
                seen.add(k)
                out.append(ln)
        threats_block = out

    tags = []
    if tags_line:
        tags = [t.strip() for t in re.split(r"[,\s]+", tags_line) if t.strip()]

    return {
        "file_name": file_name,
        "mime": mime,
        "file_info": file_info,
        "sha256": sha256,
        "verdict": verdict,
        "tags": tags,
        "threats": threats_block or [],
    }
